{"version":3,"file":"tabtree.min.js","sources":["../../src/courseformat/tabtree.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\nimport {BaseComponent} from 'core/reactive';\nimport {getCurrentCourseEditor} from 'core_courseformat/courseeditor';\nimport Templates from 'core/templates';\n\n\n/**\n * Course section tabs updater.\n *\n * @module     format_multitopic/courseformat/tabtree\n * @class      format_multitopic/courseformat/tabtree\n * @copyright  2022 Jeremy FitzPatrick and Te WƒÅnanga o Aotearoa\n * @copyright  based on work by 2021 Ferran Recio <ferran@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nexport default class Component extends BaseComponent {\n\n    /**\n     * Constructor hook.\n     */\n    create() {\n        // Optional component name for debugging.\n        this.name = 'coursetabs';\n        // Default query selectors.\n        this.selectors = {\n            TAB: `ul:first-of-type li`,\n            CHILDTAB: `ul:nth-child(2) li`\n        };\n        // Default classes\n        this.classes = {\n            ACTIVETAB: 'active'\n        };\n        // Objects to keep tabs on the tabs\n        this.tabs = {};\n        this.childtabs = {};\n        this.activetab = 0;\n    }\n\n    getWatchers() {\n        return [\n            // Sections sorting.\n            {watch: `course.sectionlist:updated`, handler: this._refreshCourseSectionTabs},\n        ];\n    }\n\n    static init(target) {\n        return new Component({\n            element: document.getElementById(target),\n            reactive: getCurrentCourseEditor()\n        });\n    }\n\n    /**\n     * Initial state ready method.\n     *\n     */\n    stateReady() {\n        // Get tab elements.\n        const tabs = this.getElements(this.selectors.TAB);\n        for (let i = 0; i < tabs.length - 1; i++) { // Don't count last \"add section\" tab.\n            let tab = tabs.item(i);\n            let id = tab.querySelector(\"a div\").dataset.itemid;\n            let classes = tab.querySelector(\"a\").classList.value;\n            this.tabs[id] = tab;\n            if (classes.indexOf(this.classes.ACTIVETAB) !== -1) {\n                this.activetab = i;\n            }\n        }\n\n        const childtabs = this.getElements(this.selectors.CHILDTAB);\n        for (let i = 0; i < childtabs.length - 1; i++) { // Don't count last \"add section\" tab.\n            let tab = childtabs.item(i);\n            let id = tab.querySelector(\"a div\").dataset.itemid;\n            this.childtabs[id] = tab;\n        }\n    }\n\n    /**\n     * Refresh the section tabs.\n     *\n     * @param {object} param\n     * @param {Object} param.element\n     */\n    _refreshCourseSectionTabs({element}) {\n        // Do things that make the first row tabs match firstsectionlist.\n        const toptabslist = element.firstsectionlist ?? [];\n        let toptabs = this.element.querySelector('ul:first-of-type');\n        this._fixOrder(toptabs, toptabslist, this.tabs);\n\n        // And the second row tabs match secondsectionlist.\n        const childtabslist = element.secondsectionlist ?? [];\n        let childtabs = this.element.querySelector('ul:nth-of-type(2)');\n        if (childtabs) {\n            this._fixOrder(childtabs, childtabslist[this.activetab], this.childtabs);\n        }\n    }\n\n    /**\n     * Fix/reorder the section or cms order.\n     *\n     * @param {Element} container the HTML element to reorder.\n     * @param {Array} neworder an array with the ids order\n     * @param {Array} allitems the list of html elements that can be placed in the container\n     */\n    _fixOrder(container, neworder, allitems) {\n\n        // Empty lists should not be visible.\n        if (!neworder.length) {\n            container.classList.add('hidden');\n            container.innerHTML = '';\n            return;\n        }\n\n        // Grant the list is visible (in case it was empty).\n        container.classList.remove('hidden');\n\n        // Move the elements in order at the beginning of the list.\n        neworder.forEach((itemid, index) => {\n\n            if (allitems[itemid] === undefined) {\n                // If we don't have an item, create it from the course index.\n                let selecta = \"[data-id='\" + itemid + \"']\";\n                let ciElement = document.querySelector(selecta);\n                let ciLink = ciElement.querySelector(\" a.courseindex-link\");\n                let data = {\n                    \"active\": 0,\n                    \"inactive\": ciElement.classList.contains(\"dimmed\"),\n                    \"link\": [{\n                    \"link\": ciLink.getAttribute(\"href\")\n                }],\n                    \"title\": ciLink.innerHTML,\n                    \"text\": ciLink.innerHTML\n                };\n                let tab = document.createElement(\"li\");\n                allitems[itemid] = tab;\n                container.insertBefore(tab, container.lastElementChild);\n                Templates.render(\"format_multitopic/courseformat/tab\", data).done(function(html) {\n                    Templates.replaceNode(item, html);\n                });\n            }\n            const item = allitems[itemid];\n\n            // Get the current element at that position.\n            const currentitem = container.children[index];\n            if (currentitem === undefined) {\n                container.append(item);\n                return;\n            }\n            if (currentitem !== item) {\n                container.insertBefore(item, currentitem);\n            }\n        });\n        // Remove the remaining elements.\n        // But we don't want the \"Add\" blown away.\n        while (container.children.length > neworder.length + 1) {\n                container.removeChild(container.lastElementChild.previousSibling);\n        }\n\n    }\n\n}"],"names":["Component","BaseComponent","create","name","selectors","TAB","CHILDTAB","classes","ACTIVETAB","tabs","childtabs","activetab","getWatchers","watch","handler","this","_refreshCourseSectionTabs","target","element","document","getElementById","reactive","stateReady","getElements","i","length","tab","item","id","querySelector","dataset","itemid","classList","value","indexOf","toptabslist","firstsectionlist","toptabs","_fixOrder","childtabslist","secondsectionlist","container","neworder","allitems","add","innerHTML","remove","forEach","index","undefined","selecta","ciElement","ciLink","data","contains","getAttribute","createElement","insertBefore","lastElementChild","render","done","html","replaceNode","currentitem","children","append","removeChild","previousSibling"],"mappings":";;;;;;;;;yJA8BqBA,kBAAkBC,wBAKnCC,cAESC,KAAO,kBAEPC,UAAY,CACbC,0BACAC,oCAGCC,QAAU,CACXC,UAAW,eAGVC,KAAO,QACPC,UAAY,QACZC,UAAY,EAGrBC,oBACW,CAEH,CAACC,mCAAqCC,QAASC,KAAKC,wCAIhDC,eACD,IAAIjB,UAAU,CACjBkB,QAASC,SAASC,eAAeH,QACjCI,UAAU,4CAQlBC,mBAEUb,KAAOM,KAAKQ,YAAYR,KAAKX,UAAUC,SACxC,IAAImB,EAAI,EAAGA,EAAIf,KAAKgB,OAAS,EAAGD,IAAK,KAClCE,IAAMjB,KAAKkB,KAAKH,GAChBI,GAAKF,IAAIG,cAAc,SAASC,QAAQC,OACxCxB,QAAUmB,IAAIG,cAAc,KAAKG,UAAUC,WAC1CxB,KAAKmB,IAAMF,KACiC,IAA7CnB,QAAQ2B,QAAQnB,KAAKR,QAAQC,kBACxBG,UAAYa,SAInBd,UAAYK,KAAKQ,YAAYR,KAAKX,UAAUE,cAC7C,IAAIkB,EAAI,EAAGA,EAAId,UAAUe,OAAS,EAAGD,IAAK,KACvCE,IAAMhB,UAAUiB,KAAKH,GACrBI,GAAKF,IAAIG,cAAc,SAASC,QAAQC,YACvCrB,UAAUkB,IAAMF,KAU7BV,oFAA0BE,QAACA,oBAEjBiB,0CAAcjB,QAAQkB,wEAAoB,OAC5CC,QAAUtB,KAAKG,QAAQW,cAAc,yBACpCS,UAAUD,QAASF,YAAapB,KAAKN,YAGpC8B,4CAAgBrB,QAAQsB,yEAAqB,OAC/C9B,UAAYK,KAAKG,QAAQW,cAAc,qBACvCnB,gBACK4B,UAAU5B,UAAW6B,cAAcxB,KAAKJ,WAAYI,KAAKL,WAWtE4B,UAAUG,UAAWC,SAAUC,cAGtBD,SAASjB,cACVgB,UAAUT,UAAUY,IAAI,eACxBH,UAAUI,UAAY,QAK1BJ,UAAUT,UAAUc,OAAO,UAG3BJ,SAASK,SAAQ,CAAChB,OAAQiB,iBAEGC,IAArBN,SAASZ,QAAuB,KAE5BmB,QAAU,aAAenB,OAAS,KAClCoB,UAAYhC,SAASU,cAAcqB,SACnCE,OAASD,UAAUtB,cAAc,uBACjCwB,KAAO,QACG,WACEF,UAAUnB,UAAUsB,SAAS,eACjC,CAAC,MACDF,OAAOG,aAAa,gBAEnBH,OAAOP,eACRO,OAAOP,WAEfnB,IAAMP,SAASqC,cAAc,MACjCb,SAASZ,QAAUL,IACnBe,UAAUgB,aAAa/B,IAAKe,UAAUiB,qCAC5BC,OAAO,qCAAsCN,MAAMO,MAAK,SAASC,yBAC7DC,YAAYnC,KAAMkC,eAG9BlC,KAAOgB,SAASZ,QAGhBgC,YAActB,UAAUuB,SAAShB,YACnBC,IAAhBc,YAIAA,cAAgBpC,MAChBc,UAAUgB,aAAa9B,KAAMoC,aAJ7BtB,UAAUwB,OAAOtC,SASlBc,UAAUuB,SAASvC,OAASiB,SAASjB,OAAS,GAC7CgB,UAAUyB,YAAYzB,UAAUiB,iBAAiBS"}