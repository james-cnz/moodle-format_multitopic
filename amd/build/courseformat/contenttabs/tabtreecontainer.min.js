define("format_multitopic/courseformat/contenttabs/tabtreecontainer",["exports","core/reactive","core_courseformat/courseeditor","format_multitopic/courseformat/contenttabs/tab","core/templates"],(function(_exports,_reactive,_courseeditor,_tab,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course section tabs updater.
   *
   * @module     format_multitopic/courseformat/contenttabs/tabtreecontainer
   * @class      format_multitopic/courseformat/contenttabs/tabtreecontainer
   * @copyright  2022 Jeremy FitzPatrick and Te WƒÅnanga o Aotearoa
   * @copyright  2023 onwards James Calder and Otago Polytechnic
   * @copyright  based on work by 2021 Ferran Recio <ferran@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_tab=_interopRequireDefault(_tab),_templates=_interopRequireDefault(_templates);class Component extends _reactive.BaseComponent{create(){this.name="contenttabs",this.selectors={SECTIONL0:"ul:first-of-type li",SECTIONL1:"ul:nth-child(2) li",SECTION_ITEM:"a.nav-link"},this.classes={ACTIVETAB:"active"},this.sectionsl0={},this.sectionsl1={},this.activetab=[null,null]}static init(target){return new this({element:document.querySelector(target),reactive:(0,_courseeditor.getCurrentCourseEditor)()})}stateReady(){this._indexContents()}getWatchers(){return[{watch:"course.sectionlist:updated",handler:this._refreshCourseSectionlist},{watch:"course.sectionlevellist:updated",handler:this._refreshCourseSectionlist}]}getElement(query,dataId){if(dataId.match(/^add\d*$/)){const dataSelector=":not([data-id])",selector="".concat(null!=query?query:"").concat(dataSelector);return this.element.querySelector(selector)}return super.getElement(query,dataId)}async _refreshCourseSectionlist(_ref){var _this$reactive$pageSe,_this$reactive;let{element:element}=_ref;const originalPageSectionid=null!==(_this$reactive$pageSe=null===(_this$reactive=this.reactive)||void 0===_this$reactive?void 0:_this$reactive.pageSectionId)&&void 0!==_this$reactive$pageSe?_this$reactive$pageSe:document.querySelector("ul.section-list").dataset.originalsinglesectionid,originalPageSection=this.reactive.get("section",originalPageSectionid);let pageSectionId,pageSection;originalPageSection?(pageSectionId=originalPageSection.levelsan<2?originalPageSection.id:originalPageSection.pageid,pageSection=pageSectionId==originalPageSection.id?originalPageSection:this.reactive.get("section",pageSectionId)):(pageSectionId=null,pageSection=null);let newActiveTab=[null,null];pageSection&&(newActiveTab[1]=pageSection.id,newActiveTab[0]=pageSection.levelsan>=1?pageSection.parentid:pageSection.id);const tabsrow=this._getTabRows(element,newActiveTab);tabsrow[1].length||(newActiveTab[1]=null);let tabsSecondRowDom=this.element.querySelector("ul:nth-of-type(2)");!tabsSecondRowDom||tabsrow[1].length&&newActiveTab[0]==this.activetab[0]||(tabsSecondRowDom.remove(),tabsSecondRowDom=null,this.activetab[1]=null);for(let level=0;level<2;level++){if(tabsrow[level].length){let tabsDom=this.element.querySelector("ul:nth-of-type("+(level+1)+")");var _tabsDom$querySelecto,_tabsDom$querySelecto2;if(tabsDom||(tabsDom=document.createElement("ul"),this.element.append(tabsDom),tabsDom.className="nav nav-tabs mb-3"),this.activetab[level]&&newActiveTab[level]!=this.activetab[level])null===(_tabsDom$querySelecto=tabsDom.querySelector('div[data-itemid="'+this.activetab[level]+'"]'))||void 0===_tabsDom$querySelecto||_tabsDom$querySelecto.parentElement.classList.remove("active"),this.activetab[level]=null;if(await this._fixOrder(tabsDom,tabsrow[level],level?this.selectors.SECTIONL1:this.selectors.SECTIONL0,level),newActiveTab[level])this.activetab[level]=newActiveTab[level],null===(_tabsDom$querySelecto2=tabsDom.querySelector('div[data-itemid="'+this.activetab[level]+'"]'))||void 0===_tabsDom$querySelecto2||_tabsDom$querySelecto2.parentElement.classList.add("active")}this.activetab[level]=newActiveTab[level]}this._indexContents()}_getTabRows(element,newActiveTab){let tabsrow=[[],[]],depthmax=-1,depthactive=-1;for(let sectionid of element.sectionlist){const section=this.reactive.get("section",sectionid);if(!(section.component||section.levelsan>=2)){if(section.levelsan<0||section.id==newActiveTab[section.levelsan])for(let level=section.levelsan;level<2&&(level<0||section.id==newActiveTab[level]);level++)depthactive=level;else depthactive=Math.min(depthactive,section.levelsan-1);section.levelsan>=0&&section.levelsan<=depthactive+1&&(tabsrow[section.levelsan].push(section.id),depthmax=Math.max(depthmax,section.levelsan))}}for(let level=0;level<=Math.min(depthmax+1,1);level++){const parentid=0==level?element.sectionlist[0]:newActiveTab[level-1];tabsrow[level].unshift(parentid),tabsrow[level].push("add"+parentid)}return tabsrow}_indexContents(){this._scanIndex(this.selectors.SECTIONL0,this.sectionsl0,(item=>new _tab.default(item)),0),this._scanIndex(this.selectors.SECTIONL1,this.sectionsl1,(item=>new _tab.default(item)),1)}_scanIndex(selector,index,creationhandler,level){this.getElements("".concat(selector,":not([data-indexed])")).forEach((item=>{var _item$dataset;if(null==item||null===(_item$dataset=item.dataset)||void 0===_item$dataset||!_item$dataset.id)return;void 0!==index[item.dataset.id]&&index[item.dataset.id].unregister(),index[item.dataset.id]=creationhandler({...this,element:item}),item.querySelector("a").classList.contains(this.classes.ACTIVETAB)&&(this.activetab[level]=item.dataset.id),item.dataset.indexed=!0}))}async _createSectionItem(container,sectionid,level){let data;if(isNaN(parseInt(sectionid))){var _addTab0Dom$querySele;const addTab0Dom=this.element.querySelector("ul:first-of-type li:last-of-type");data={level:level,active:!1,inactive:addTab0Dom.querySelector("a").classList.contains("disabled"),link:[{link:null===(_addTab0Dom$querySele=addTab0Dom.querySelector("a").getAttribute("href"))||void 0===_addTab0Dom$querySele?void 0:_addTab0Dom$querySele.replace(/\binsertparentid=\d+\b/,"insertparentid="+sectionid.match(/^add(\d+)$/)[1]).replace(/\binsertlevel=0\b/,"insertlevel="+level)}],title:addTab0Dom.querySelector("a").getAttribute("title"),text:'<i class="icon fa fa-plus fa-fw" title="'+addTab0Dom.querySelector("a").getAttribute("title")+'"></i>'}}else{const section=this.reactive.get("section",sectionid),visible=(section.visible&&section.available||0==section.section)&&level<=section.pagedepthdirect,current=null!=section.currentnestedlevel&&section.currentnestedlevel>=level;data={sectionid:section.id,level:level,active:0,inactive:0,link:[{link:section.sectionurl}],title:section.name,text:'<div class="tab_content'+(visible?"":" dimmed")+(current?" marker":"")+'" data-itemid="'+section.id+'">'+section.title+"</div>"}}let newItem=document.createElement("li");const{html:html}=await _templates.default.renderForPromise("format_multitopic/courseformat/contenttabs/tab",data);return newItem=_templates.default.replaceNode(newItem,html,"")[0],newItem}async _fixOrder(container,neworder,selector,level){if(!neworder.length)return container.classList.add("hidden"),void(container.innerHTML="");container.classList.remove("hidden");for(const[index,itemid]of Object.entries(neworder)){var _this$getElement;let item=null!==(_this$getElement=this.getElement(selector,itemid))&&void 0!==_this$getElement?_this$getElement:await this._createSectionItem(container,itemid,level);const currentitem=container.children[index];void 0===currentitem?container.append(item):currentitem!==item&&container.insertBefore(item,currentitem)}for(;container.children.length>neworder.length;)container.removeChild(container.lastChild)}}return _exports.default=Component,_exports.default}));

//# sourceMappingURL=tabtreecontainer.min.js.map